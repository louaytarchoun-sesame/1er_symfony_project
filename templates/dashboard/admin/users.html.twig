{% extends 'dashboard/layout.html.twig' %}

{% block sidebar %}
    {% include 'dashboard/admin/_sidebar.html.twig' %}
{% endblock %}

{% block dashboard_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-people-fill me-2"></i>Gestion des utilisateurs</h2>
    <span class="badge bg-primary fs-6">{{ users|length }} utilisateur{{ users|length > 1 ? 's' : '' }}</span>
</div>

{# ── Flash messages ── #}
{% for type, messages in app.flashes %}
    {% for message in messages %}
        <div class="alert alert-{{ type }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endfor %}
{% endfor %}

{# ── Search bar ── #}
<div class="card shadow-sm mb-4">
    <div class="card-body py-2">
        <div class="input-group">
            <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
            <input type="text" id="searchCin" class="form-control border-start-0"
                   placeholder="Rechercher par CIN..." autocomplete="off">
        </div>
    </div>
</div>

{# ── Users table ── #}
<div class="card shadow-sm">
    <div class="card-body p-0">
        <table class="table table-hover align-middle mb-0" id="usersTable">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>CIN</th>
                    <th>Nom</th>
                    <th>Prénom</th>
                    <th>Rôle</th>
                    <th>Téléphone</th>
                    <th>Sexe</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
            {% for user in users %}
                <tr data-cin="{{ user.cin }}">
                    <td>{{ user.id }}</td>
                    <td><code>{{ user.cin }}</code></td>
                    <td>{{ user.name }}</td>
                    <td>{{ user.lastName }}</td>
                    <td>
                        {% if user.role == 'PATIENT' %}
                            <span class="badge bg-info">Patient</span>
                        {% elseif user.role == 'MEDECIN' %}
                            <span class="badge bg-success">Médecin</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ user.role }}</span>
                        {% endif %}
                    </td>
                    <td>{{ user.tel }}</td>
                    <td>{{ user.sexe }}</td>
                    <td class="text-center">
                        <form method="POST" action="{{ path('admin_user_delete', {id: user.id}) }}"
                              onsubmit="return confirm('Supprimer {{ user.name }} {{ user.lastName }} ({{ user.cin }}) ? Cette action est irréversible.')">
                            <input type="hidden" name="_token" value="{{ csrf_token('delete_user_' ~ user.id) }}">
                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                <i class="bi bi-trash-fill"></i> Supprimer
                            </button>
                        </form>
                    </td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="8" class="text-center text-muted py-4">Aucun utilisateur trouvé.</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<p id="noResults" class="text-center text-muted mt-3 d-none">Aucun résultat pour cette recherche.</p>
{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const input = document.getElementById('searchCin');
    const rows  = document.querySelectorAll('#usersTable tbody tr[data-cin]');
    const noRes = document.getElementById('noResults');

    input.addEventListener('input', function () {
        const query = this.value.trim().toLowerCase();
        let visible = 0;

        rows.forEach(function (row) {
            const cin = row.getAttribute('data-cin').toLowerCase();
            if (cin.includes(query)) {
                row.style.display = '';
                visible++;
            } else {
                row.style.display = 'none';
            }
        });

        noRes.classList.toggle('d-none', visible > 0 || query === '');
    });
});
</script>
{% endblock %}
